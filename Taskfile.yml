# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

version: '3'

vars:
  BASETAG: 0.3.0-morpheus
  TAG:
    sh: git describe --tags --abbrev=0 2>/dev/null
  TIMESTAMP:
    sh: date +%y%m%d%H
  S: ""
  T: ""

tasks:

  setup: 
    silent: true

  yaml: 
    silent: true
    cmds: 
     - |-
       A="{{.CLI_ARGS}}"
       if test -z "$A"
       then ls -1 *.yml | sed -e 's/.yml//' -e 's/^/- /'
       echo "edit(@)" or run  with '"task yaml -- [@]<script>"'
       elif test "${A:0:1}" = "@"
       then code ${A:1}.yml roles/${A:1}/tasks/deploy.yml
       else ansible-playbook -i environments/local -e docker_image_prefix=testing "$A".yml
       fi
    dir: openwhisk/ansible

  init:
    cmds:
     - task: clean
     - rm -Rvf ../openwhisk-utilities
     - ./tools/github/setup.sh
    dir: openwhisk

  clean:
   - docker ps -qa | xargs docker rm -f

  tests:
    silent: true
    cmds: 
     - |-
       A="{{.CLI_ARGS}}"
       if test -z "$A"
       then ls tools/github/run* | sed -e 's!^.*run\(.*\)Tests.sh$!- \1!'
       echo "edit(@)" or run  with '"task yaml -- [@]<script>"'
       elif test "${A:0:1}" = "@"
       then code tools/github/run${A:1}Tests.sh
       else echo ./tools/github/run${A:1}Tests.sh
       fi
    dir: openwhisk
 
  setups:
    silent: true
    cmds: 
     - |-
       A="{{.CLI_ARGS}}"
       if test -z "$A"
       then ls tools/travis/setup* | sed -e 's!^.*setup\(.*\)Tests.sh$!- \1!'
       echo "edit(@)" or run  with '"task yaml -- [@]<script>"'
       elif test "${A:0:1}" = "@"
       then code tools/github/run${A:1}Tests.sh
       else echo ./tools/github/run${A:1}Tests.sh
       fi
    dir: openwhisk
 
  tar-actions:
    cmds:
     - rm -f actions.tar
     - > 
        tar cvf ../actions.tar 
        .github/workflows tools/github
    dir: openwhisk

  image-tag: 
    - git tag -d $(git tag) ; git tag -f {{.BASETAG}}.{{.TIMESTAMP}}{{.S}} ; git tag
    - |
      cd openwhisk
      git tag | xargs git tag -d
      git tag -f {{.BASETAG}}.{{.TIMESTAMP}}{{.S}}
      git tag

  tag-and-push:
    - task: image-tag
    - cd openwhisk ; git push upstream --tags
