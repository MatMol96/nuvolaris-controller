# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
version: '3'

dotenv: 
  - .env

vars:
  BASETAG: 0.3.0-morpheus
  TAG:
    sh: git describe --tags --abbrev=0 2>/dev/null || echo "undefined"
  CONTROLLER_IMAGE: ghcr.io/nuvolaris/openwhisk-controller
  INVOKER_IMAGE: ghcr.io/nuvolaris/openwhisk-invoker
  STANDALONE_IMAGE: ghcr.io/nuvolaris/openwhisk-standalone
  ACT: "undefined"
  S: ""

tasks:
  default:
    - task --list-all
  setup: 
    silent: true

  image-tag: 
    - git tag -d $(git tag)
    - git tag -f {{.BASETAG}}.$(date +%y%m%d%H){{.S}}
    - task show

  show:
    silent: true
    cmds:
      - echo "tag:" {{.TAG}}
      - echo "controller:" ${MY_CONTROLLER_IMAGE:-{{.CONTROLLER}}}:{{.TAG}}
      - echo "invoker:" ${MY_INVOKER_IMAGE:-{{.INVOKER}}}:{{.TAG}}
      - echo "standalone:" ${MY_STANDALONE_IMAGE:-{{.STANDALONE}}}:{{.TAG}}

  compile:controller:
    dir: openwhisk
    cmds:
      - ./gradlew  :core:controller:distTar
    status:
      - test -f core/controller/build/distributions/controller.tar

  compile:invoker:
    dir: openwhisk
    cmds:
      - ./gradlew  :core:invoker:distTar
    status:
      - test -f core/invoker/build/distributions/invoker.tar

  compile:standalone:
    dir: openwhisk
    cmds:
      - ./gradlew :core:standalone:build
      - mkdir -p ../standalone/lib
      - cp bin/openwhisk-standalone.jar ../standalone/lib/
    status:
      - test -f ../standalone/lib/openwhisk-standalone.jar

  clean:
    - rm standalone/lib/openwhisk-standalone.jar
    - rm openwhisk/core/invoker/build/distributions/invoker.tar
    - rm openwhisk/core/controller/build/distributions/controller.tar

  compile:
    - task: compile:controller
    - task: compile:invoker
    - task: compile:standalone

  # this requires the IMG and DIR parameters to be invoked
  docker-build:
    silent: true
    cmds:
    - |-
      case "{{.ACT}}" in
      (build) docker build {{.DIR}} -t {{.IMG}} ;;
      (buildx) docker buildx build --platform linux/amd64,linux/arm64 -t {{.IMG}} {{.DIR}} ;;
      (build-push) docker build {{.DIR}} -t {{.IMG}} ; docker push {{.IMG}} ;;
      (buildx-push) docker buildx build --platform linux/amd64,linux/arm64 -t {{.IMG}} {{.DIR}} --push ;;
      (*) echo action undefined
      esac

  build:scala:
    cmds:
      - task: docker-build
        vars:
          DIR: openwhisk/common/scala
          IMG: "scala"
          ACT: '{{.ACT | or "build"}}'

  build:controller:
    deps:
    - compile:controller
    cmds:
      - task: docker-build
        vars:
          DIR: openwhisk/core/controller
          IMG: "${MY_CONTROLLER_IMAGE:-{{.CONTROLLER_IMAGE}}}:{{.TAG}}"
          ACT: '{{.ACT | or "build"}}'
 
  build:invoker:
    deps:
    - compile:invoker
    cmds:
      - task: docker-build
        vars:
          DIR: openwhisk/core/invoker
          IMG: "${MY_INVOKER_IMAGE:-{{.INVOKER_IMAGE}}}:{{.TAG}}"
          ACT: '{{.ACT | or "build"}}'
  

  build:standalone:
    deps:
    - compile:standalone
    cmds:
      - task: docker-build
        vars:
          DIR: standalone
          IMG: "${MY_STANDALONE_IMAGE:-{{.STANDALONE_IMAGE}}}:{{.TAG}}"
          ACT: '{{.ACT | or "build"}}'
  
  build-and-push:
    cmds:
    - task: build:scala
      vars:
         ACT: "build" 
    - task: build:controller
      vars:
         ACT: "build-push"      
    - task: build:invoker
      vars:
         ACT: "build-push"
    - task: build:standalone
      vars:
         ACT: "build-push"

  buildx-prepare:
    - docker buildx install
    - docker buildx create --name nuvolaris


  buildx-and-push:
    - task: build:scala
      vars:
         ACT: "buildx" 
    - task: build:controller
      vars:
         ACT: "buildx-push"      
    - task: build:invoker
      vars:
         ACT: "buildx-push"
    - task: build:standalone
      vars:
         ACT: "buildx-push"
