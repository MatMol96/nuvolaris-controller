version: '3'

env:
    TESTCONTAINERS_RYUK_DISABLED: true

dotenv: 
  - .env

tasks:

  default: 
    cmds: 
     - |-
       if test -z "{{.CLI_ARGS}}"
       then ls *.yml
       else ansible-playbook -i environments/local -e docker_image_prefix=testing {{.CLI_ARGS}}
       fi
    dir: openwhisk/ansible

  setup: echo ok

  reset: docker ps -qa | xargs docker rm -f

  prepare:
    cmds: 
      # todo: what is that runtimes nodeonly
      - docker pull alpine:3.5
      - ./distDocker.sh
    dir: openwhisk/tools/travis

  unit-setup: 
    cmds:
      - ./setupPrereq.sh
    dir: openwhisk/tools/travis
  
  unit-test:
    cmds:
      - ./runTests.sh
    dir: openwhisk/tools/travis
    env:
      ORG_GRADLE_PROJECT_testSetName: REQUIRE_ONLY_DB

  unit-logs:
    cmds:
      - ./tools/github/checkAndUploadLogs.sh unit db
    dir: openwhisk
    env:
      GH_BUILD_ID:
          sh: date +%s
      GH_BRANCH:
        sh:  git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/'

  logs-upload:
    cmds:
      - ./tools/github/s3-upload.sh "$PWD/logs" test-upload.tar.gz
    dir: openwhisk

  system:
    cmds:
      - ./setupSystem.sh /ansible/files/runtimes-nodeonly.json
      - ./runTests.sh
    dir: openwhisk/tools/travis
    env:
      ORG_GRADLE_PROJECT_testSetName: REQUIRE_SYSTEM

  show:
    cmds:
      - python3 -m http.server
    dir: results

